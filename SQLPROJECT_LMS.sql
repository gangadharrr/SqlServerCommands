USE [Learning Management System];

IF EXISTS (SELECT * FROM sysobjects WHERE name='LMS_BOOK_ISSUE' and xtype='U')
DROP TABLE LMS_BOOK_ISSUE;
IF EXISTS (SELECT * FROM sysobjects WHERE name='LMS_BOOK_DETAILS' and xtype='U')
DROP TABLE LMS_BOOK_DETAILS;
IF EXISTS (SELECT * FROM sysobjects WHERE name='LMS_MEMBERS' and xtype='U')
DROP TABLE LMS_MEMBERS;
IF EXISTS (SELECT * FROM sysobjects WHERE name='LMS_FINE_DETAILS' and xtype='U')
DROP TABLE LMS_FINE_DETAILS;
IF EXISTS (SELECT * FROM sysobjects WHERE name='LMS_SUPPLIERS_DETAILS' and xtype='U')
DROP TABLE LMS_SUPPLIERS_DETAILS;

CREATE TABLE LMS_SUPPLIERS_DETAILS
(
	SUPPLIER_ID VARCHAR(3) PRIMARY KEY,
	SUPPLIER_NAME VARCHAR(30),
	ADDRESS_ VARCHAR(50),
	CONTACT INTEGER,
	EMAIL VARCHAR(15)
);

CREATE TABLE LMS_BOOK_DETAILS
(
	BOOK_CODE VARCHAR(10) PRIMARY KEY,
	BOOK_TITLE VARCHAR(50),
	CATEGORY VARCHAR(15),
	AUTHOR VARCHAR(30),
	PUBLICATION VARCHAR(30),
	PUBLISH_DATE DATE,
	BOOK_EDTION INT,
	PRICE FLOAT,
	RACK_NUM VARCHAR(3),
	DATE_ARRIVAL DATE,
	SUPPLIER_ID VARCHAR(3)
	FOREIGN KEY(SUPPLIER_ID) REFERENCES LMS_SUPPLIERS_DETAILS(SUPPLIER_ID) ON DELETE CASCADE
);

CREATE TABLE LMS_MEMBERS
(
	MEMBER_ID VARCHAR(10) PRIMARY KEY,
	MEMBER_NAME VARCHAR(30),
	CITY VARCHAR(20),
	DATE_REGISTER DATE,
	DATE_EXPIRE DATE,
	MEMBERSHIP_STATUS VARCHAR(15)
);

CREATE TABLE LMS_FINE_DETAILS
(
	FINE_RANGE VARCHAR(3) PRIMARY KEY,
	FINE_AMOUNT INTEGER,
);

CREATE TABLE LMS_BOOK_ISSUE
(
	BOOK_ISSUE_NO INT IDENTITY(1,1) PRIMARY KEY,
	MEMBER_ID VARCHAR(10),
	BOOK_CODE VARCHAR(10),
	DATE_ISSUE DATE,
	DATE_RETURN DATE,
	DATE_RETURNED DATE,
	FINE_RANGE VARCHAR(3)
	FOREIGN KEY(MEMBER_ID) REFERENCES LMS_MEMBERS(MEMBER_ID) ON DELETE CASCADE,
	FOREIGN KEY(BOOK_CODE) REFERENCES LMS_BOOK_DETAILS(BOOK_CODE) ON DELETE CASCADE,
	FOREIGN KEY(FINE_RANGE) REFERENCES LMS_FINE_DETAILS(FINE_RANGE) ON DELETE CASCADE,
);

INSERT INTO LMS_SUPPLIERS_DETAILS VALUES
('S01','SINGAPORE SHOPPEE','CHENNAI',98941235,'sing@gmail.com'),
('S02','JK Stores','MUMBAI',99401234,'jks@yahoo.com'),
('S03','ROSE BOOK STORE','TRIVANDRUM',94444112,'rose@gmail.com'),
('S04','KAVARI STORE','DELHI',86300014,'kavi@redif.com'),
('S05','EINSTEN BOOK GALLARY','US',95420000,'eingal@aol.com'),
('S06','AKBAR STORE','MUMBAI',78556231,'akbakst@aol.com');
SELECT * FROM LMS_SUPPLIERS_DETAILS;

INSERT INTO LMS_BOOK_DETAILS VALUES
('BL000010','Java For Dummies','JAVA','Paul j. Deitel','Prentice Hall','1999-12-10',6,575.00,'A1','2011-05-10','S01'),
('BL000002','Java: The Complete Revesion','JAVA','Herbert Schildt','Tata Mcgraw Hill','2011-10-10',5,750.00,'A1','2011-05-10','S03'),
('BL000003','Java: How To Do Program','JAVA','Paul j. Deitel','Prentice Hall','1999-05-10',6,600.00,'A1','2012-05-10','S01'),
('BL000004','Java: The Complete Revesion','JAVA','Herbert Schildt','Tata Mcgraw Hill','2011-10-10',5,750.00,'A1','2012-05-11','S01'),
('BL000005','Java: How To Do Program','JAVA','Paul j. Deitel','Prentice Hall','1999-05-10',6,600.00,'A1','2012-05-11','S01'),
('BL000006','Java: The Complete Revesion','JAVA','Herbert Schildt','Tata Mcgraw Hill','2011-10-10',5,750.00,'A1','2012-05-12','S03'),
('BL000007','Let Us C','C','Yashavant Kanetkar','BPB Publications','2010-12-11',9,500.00,'A3','2010-11-03','S03'),
('BL000008','Let Us C','C','Yashavant Kanetkar','BPB Publications','2010-05-12',9,500.00,'A3','2011-08-09','S04'),
('BL000009','Let Us C#','C','Yashavant Kanetkar','BPB Publications','2010-05-12',9,550.00,'A3','2011-08-09','S04'),
('BL000011','Let Us C++','C','Yashavant Kanetkar','BPB Publications','2010-05-12',9,650.00,'A3','2011-08-09','S04');
SELECT * FROM LMS_BOOK_DETAILS;

INSERT INTO LMS_MEMBERS VALUES
('LM001','AMIT','CHENNAI','2012-02-12','2013-02-11','Temporary'),
('LM002','ABDHUL','DELHI','2012-04-10','2013-04-09','Temporary'),
('LM003','GAYAN','CHENNAI','2012-05-13','2013-05-12','Permanent'),
('LM004','RADHA','CHENNAI','2012-04-22','2013-04-21','Temporary'),
('LM005','GURU','BANGALORE','2012-03-30','2013-05-16','Temporary'),
('LM006','MOHAN','CHENNAI','2012-04-12','2013-05-16','Temporary');
SELECT * FROM LMS_MEMBERS;

INSERT INTO LMS_FINE_DETAILS VALUES
('R0',0.00),
('R1',20.00),
('R2',50.00),
('R3',75.00),
('R4',100.00),
('R5',150.00),
('R6',200.00)
SELECT * FROM LMS_FINE_DETAILS;

INSERT INTO LMS_BOOK_ISSUE VALUES
('LM001','BL000010','2012-05-01','2012-05-16','2012-05-16','R0'),
('LM002','BL000002','2012-05-01','2012-05-06','2012-05-16','R2'),
('LM003','BL000007','2012-04-01','2012-04-16','2012-04-20','R1'),
('LM004','BL000005','2012-04-01','2012-04-16','2012-04-20','R1'),
('LM005','BL000008','2012-03-30','2012-04-15','2012-04-20','R1'),
('LM005','BL000008','2012-04-20','2012-05-05','2012-05-05','R0'),
('LM003','BL000007','2012-04-22','2012-05-07','2012-05-25','R4');
SELECT * FROM LMS_BOOK_ISSUE

--1.
EXEC sp_help 'dbo.LMS_BOOK_ISSUE';
--2.
SELECT * FROM LMS_FINE_DETAILS;
--3.
SELECT MEMBER_NAME FROM LMS_MEMBERS WHERE CITY='CHENNAI'
--4.
SELECT MEMBER_ID,MEMBER_NAME,CITY,MEMBERSHIP_STATUS FROM LMS_MEMBERS WHERE MEMBERSHIP_STATUS='Permanent'
--5.
SELECT MEMBER_ID,MEMBER_NAME FROM LMS_MEMBERS WHERE MEMBER_ID = (SELECT MEMBER_ID FROM LMS_BOOK_ISSUE WHERE BOOK_CODE='BL000002')
--6.
SELECT BOOK_CODE,BOOK_TITLE,AUTHOR FROM LMS_BOOK_DETAILS WHERE AUTHOR LIKE 'P%';
--7.
SELECT COUNT(*) AS 'NO_OF_BOOKS' FROM LMS_BOOK_DETAILS WHERE CATEGORY='JAVA';
--8.
SELECT CATEGORY,COUNT(*) AS 'NO_OF_BOOKS' FROM LMS_BOOK_DETAILS GROUP BY CATEGORY;
--9.
SELECT COUNT(*) AS 'NO_OF_BOOKS' FROM LMS_BOOK_DETAILS WHERE PUBLICATION='Prentice Hall';
--10.
SELECT BOOK_CODE,BOOK_TITLE FROM LMS_BOOK_DETAILS WHERE BOOK_CODE IN (SELECT BOOK_CODE FROM LMS_BOOK_ISSUE WHERE DATE_ISSUE='2012-04-01');
--11.
SELECT MEMBER_ID,MEMBER_NAME,DATE_REGISTER,DATE_EXPIRE FROM LMS_MEMBERS WHERE DATE_EXPIRE<CAST('2013-04-01' AS DATE);
--12.
SELECT MEMBER_ID,MEMBER_NAME,DATE_REGISTER,MEMBERSHIP_STATUS FROM LMS_MEMBERS WHERE DATE_REGISTER<CAST('2012-03-01' AS DATE) AND MEMBERSHIP_STATUS='Temporary';
--13
SELECT MEMBER_ID,MEMBER_NAME FROM LMS_MEMBERS WHERE CITY ='CHENNAI' or CITY='BANGALORE'
--14.
SELECT CONCAT (BOOK_TITLE,'_was_written_by_' , AUTHOR) FROM LMS_BOOK_DETAILS;
--15.
SELECT AVG(PRICE) AS 'AVERAGE_PRICE' FROM LMS_BOOK_DETAILS WHERE CATEGORY = 'JAVA';
--16.
SELECT SUPPLIER_ID,SUPPLIER_NAME FROM LMS_SUPPLIERS_DETAILS WHERE EMAIL LIKE '%@gmail.com';
--17.
SELECT SUPPLIER_ID, SUPPLIER_NAME,COALESCE (CONTACT,EMAIL,ADDRESS_) AS CONTACTDETAILS FROM LMS_SUPPLIERS_DETAILS;
--18.
SELECT MEMBER_ID,MEMBER_NAME,BOOK_CODE,BOOK_TITLE FROM LMS_MEMBERS INNER JOIN LMS_BOOK_DETAILS ON  BOOK_CODE=BOOK_CODE;
--19.
SELECT LBI.MEMBER_ID,LM.MEMBER_NAME,LBI.FINE_RANGE,LFD.FINE_AMOUNT FROM LMS_BOOK_ISSUE LBI INNER JOIN LMS_MEMBERS LM ON LBI.MEMBER_ID=LM.MEMBER_ID INNER JOIN LMS_FINE_DETAILS LFD ON LBI.FINE_RANGE=LFD.FINE_RANGE WHERE LFD.FINE_AMOUNT<100;
--20.
SELECT BOOK_CODE, BOOK_TITLE, RACK_NUM FROM LMS_BOOK_DETAILS WHERE RACK_NUM='A1' ORDER BY BOOK_TITLE;
--21.
SELECT MEMBER_ID,MEMBER_NAME,DATE_REGISTER FROM LMS_MEMBERS WHERE MEMBER_ID NOT IN (SELECT MEMBER_ID FROM LMS_BOOK_ISSUE);
--22.
SELECT LBI.MEMBER_ID, LM.MEMBER_NAME FROM LMS_BOOK_ISSUE LBI INNER JOIN LMS_MEMBERS LM ON LBI.MEMBER_ID=LM.MEMBER_ID WHERE DATE_RETURN>=DATE_RETURNED AND YEAR(DATE_RETURNED)=2012;
SELECT MEMBER_ID,MEMBER_NAME FROM LMS_MEMBERS WHERE MEMBER_ID IN (SELECT MEMBER_ID FROM LMS_BOOK_ISSUE WHERE DATE_RETURN>=DATE_RETURNED AND YEAR(DATE_RETURNED)=2012);
--23.
SELECT RACK_NUM,COUNT(*) AS NoOfBooks FROM LMS_BOOK_DETAILS GROUP BY RACK_NUM ORDER BY RACK_NUM ASC;
--24.
--SELECT 
--25.

--26.
SELECT TOP 3 * FROM LMS_SUPPLIERS_DETAILS
--27.
SELECT * FROM LMS_SUPPLIERS_DETAILS WHERE SUPPLIER_ID NOT IN (SELECT TOP 3 SUPPLIER_ID FROM LMS_SUPPLIERS_DETAILS);
--28.
EXEC sp_rename 'DBO.LMS_MEMBERS', 'DBO.LMS_MEMBERS_DETAILS'; 
SELECT * FROM DBO.LMS_MEMBERS_DETAILS;
--29.
TRUNCATE table LMS_FINE_DETAILS;
--30.
SELECT BOOK_TITLE FROM LMS_BOOK_DETAILS;
SELECT * FROM LMS_BOOK_DETAILS;

DELETE FROM LMS_BOOK_DETAILS WHERE BOOK_CODE='BL000021'
UPDATE LMS_BOOK_DETAILS SET BOOK_TITLE='{book.Title}',AUTHOR='{book.Author}', PUBLICATION='{book.Publication}', PRICE=2 WHERE BOOK_CODE='BL000021'